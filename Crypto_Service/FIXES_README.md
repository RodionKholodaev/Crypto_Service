# Исправления для Crypto Service

## Описание проблем

В сервисе были обнаружены следующие проблемы:

1. **Некорректные данные в базе данных**: Поля `exchange_commission`, `service_commission`, `pnl` заполнялись значениями `0E-8` вместо реальных данных
2. **Проблемы с отображением статистики**: Графики и таблицы не отображали корректную информацию
3. **Ошибки в расчете PnL**: Неправильный расчет прибыли/убытка без учета плеча
4. **Проблемы с комиссиями**: Комиссии не рассчитывались корректно

## Внесенные исправления

### 1. Исправление логики бота (`bot_logic_ccxt.py`)

- **Расчет комиссий**: Добавлена логика расчета комиссий биржи (0.1%) если API не возвращает данные
- **Расчет PnL**: Исправлен расчет прибыли/убытка с учетом плеча бота
- **Комиссия сервиса**: Добавлен расчет комиссии сервиса (10% от прибыли)
- **Обработка Decimal**: Исправлена работа с Decimal для баланса пользователя

### 2. Исправление views (`analytics/views.py`)

- **Фильтрация данных**: Исключены сделки с нулевым PnL из статистики
- **Проверка данных**: Добавлены проверки на существование данных для графиков
- **Экспорт данных**: Добавлено поле `exit_price` в экспорт

### 3. Исправление шаблона (`dashboard.html`)

- **Отображение данных**: Исправлено отображение типа сделки (LONG/SHORT)
- **Форматирование**: Улучшено форматирование цен и объемов
- **Графики**: Исправлены условия отображения графиков
- **Таблица**: Добавлена колонка "Цена выхода"

### 4. Миграция базы данных

Создана миграция `0018_fix_deal_data.py` для исправления существующих некорректных данных:
- Замена `0E-8` на корректные значения
- Пересчет комиссий и PnL для закрытых сделок

## Инструкции по применению

### 1. Применить миграцию

```bash
python manage.py migrate bots
```

### 2. Перезапустить ботов

После применения исправлений рекомендуется перезапустить всех активных ботов для корректной работы.

### 3. Проверить данные

Убедитесь, что в базе данных корректно отображаются:
- Комиссии биржи (не `0E-8`)
- PnL сделок
- Даты создания сделок
- Цены входа и выхода

## Технические детали

### Расчет комиссий

- **Комиссия биржи**: 0.1% от стоимости ордера
- **Комиссия сервиса**: 10% от прибыли (только для прибыльных сделок)

### Расчет PnL

- **Long позиция**: `(exit_price - entry_price) * volume * leverage`
- **Short позиция**: `(entry_price - exit_price) * volume * leverage`

### Форматирование данных

- **Цены**: 8 знаков после запятой
- **Объемы**: 4 знака после запятой
- **PnL**: 2 знака после запятой
- **Комиссии**: 4 знака после запятой

## Проверка исправлений

После применения исправлений проверьте:

1. **Страница статистики** (`/analytics/dashboard/`):
   - Корректное отображение графиков
   - Правильные данные в таблице сделок
   - Корректные метрики (общая прибыль, win rate)

2. **Данные в базе**:
   - Отсутствие значений `0E-8`
   - Корректные даты создания сделок
   - Правильные расчеты PnL и комиссий

3. **Работа ботов**:
   - Корректное создание сделок
   - Правильный расчет комиссий при входе
   - Корректный расчет PnL при выходе

## Возможные проблемы

1. **Если миграция не применяется**: Проверьте зависимости и состояние базы данных
2. **Если данные не обновляются**: Убедитесь, что боты работают с новой логикой
3. **Если графики не отображаются**: Проверьте наличие данных в выбранном периоде

## Контакты

При возникновении проблем обращайтесь к разработчику или создавайте issue в репозитории.
