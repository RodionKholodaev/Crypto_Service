# Пошаговые инструкции по применению исправлений

## Шаг 1: Применение миграции

Выполните команду для применения миграции, которая исправит существующие некорректные данные:

```bash
cd Crypto_Service
python manage.py migrate bots
```

Эта миграция:
- Заменит значения `0E-8` на корректные данные
- Пересчитает комиссии и PnL для закрытых сделок
- Исправит проблемы с отображением данных

## Шаг 2: Перезапуск ботов

После применения миграции рекомендуется перезапустить всех активных ботов:

1. Остановите всех активных ботов через админ-панель
2. Подождите несколько секунд
3. Запустите ботов заново

Это обеспечит работу с новой логикой расчета комиссий и PnL.

## Шаг 3: Проверка исправлений

### 3.1 Проверка страницы статистики

Откройте страницу `/analytics/dashboard/` и убедитесь, что:

- ✅ Графики отображаются корректно
- ✅ Данные в таблице сделок корректны
- ✅ Метрики (общая прибыль, win rate) отображаются правильно
- ✅ Отсутствуют значения `0E-8`

### 3.2 Проверка данных в базе

Проверьте, что в базе данных:

- ✅ Поле `created_at` заполнено для всех сделок
- ✅ `exchange_commission` содержит реальные значения (не `0E-8`)
- ✅ `service_commission` рассчитана корректно
- ✅ `pnl` содержит правильные значения с учетом плеча

### 3.3 Проверка работы ботов

Убедитесь, что боты:

- ✅ Создают сделки с корректными комиссиями
- ✅ Правильно рассчитывают PnL при закрытии позиций
- ✅ Корректно списывают комиссии сервиса

## Шаг 4: Тестирование

### 4.1 Создание тестовой сделки

1. Создайте тестового бота с минимальным депозитом
2. Запустите бота и дождитесь создания сделки
3. Проверьте, что данные в базе корректны

### 4.2 Проверка экспорта

1. Перейдите на страницу статистики
2. Попробуйте экспортировать данные в разных форматах (CSV, JSON, Excel)
3. Убедитесь, что экспорт содержит все необходимые поля

## Возможные проблемы и решения

### Проблема 1: Миграция не применяется

**Симптомы**: Ошибка при выполнении `python manage.py migrate`

**Решение**:
```bash
# Проверьте статус миграций
python manage.py showmigrations bots

# Если есть проблемы, попробуйте
python manage.py migrate bots --fake-initial
```

### Проблема 2: Графики не отображаются

**Симптомы**: Пустые области вместо графиков

**Решение**:
1. Проверьте, что в выбранном периоде есть данные
2. Убедитесь, что сделки имеют корректные значения PnL
3. Проверьте консоль браузера на наличие ошибок JavaScript

### Проблема 3: Данные в таблице некорректны

**Симптомы**: Отображаются значения `0E-8` или `N/A`

**Решение**:
1. Убедитесь, что миграция применена успешно
2. Проверьте, что боты работают с новой логикой
3. Перезапустите ботов

### Проблема 4: Экспорт не работает

**Симптомы**: Ошибка при скачивании файлов

**Решение**:
1. Проверьте права доступа к папке для экспорта
2. Убедитесь, что все необходимые библиотеки установлены
3. Проверьте логи сервера на наличие ошибок

## Проверочный чек-лист

После применения исправлений проверьте:

- [ ] Миграция `0018_fix_deal_data` применена успешно
- [ ] Страница статистики загружается без ошибок
- [ ] Графики отображают корректные данные
- [ ] Таблица сделок содержит правильные значения
- [ ] Экспорт данных работает во всех форматах
- [ ] Боты создают сделки с корректными данными
- [ ] В базе данных отсутствуют значения `0E-8`

## Контакты для поддержки

Если у вас возникли проблемы с применением исправлений:

1. Проверьте логи сервера Django
2. Проверьте консоль браузера на наличие ошибок JavaScript
3. Убедитесь, что все зависимости установлены корректно
4. Создайте issue в репозитории с описанием проблемы

## Дополнительные рекомендации

1. **Резервное копирование**: Перед применением исправлений создайте резервную копию базы данных
2. **Тестирование**: Сначала протестируйте исправления на тестовой среде
3. **Мониторинг**: После применения следите за работой ботов и корректностью данных
4. **Документирование**: Зафиксируйте все изменения и их результаты
