{% extends 'bots/bot_conf.html' %}


{% block strategy %}
<div class="form-group">
    <label class="form-label">Алгоритм торговли</label>
    <div class="mode-selector">
        <div class="mode-option {% if form.instance.strategy %}active{% endif %}" onclick="selectMode(this, 'long')">
            <h4>Long</h4>
            <p>Покупка с ожиданием роста</p>
        </div>
        <div class="mode-option {% if not form.instance.strategy %}active{% endif %}" onclick="selectMode(this, 'short')">
            <h4>Short</h4>
            <p>Продажа с ожиданием падения</p>
        </div>
    </div>
    <input type="hidden" name="strategy" id="tradingMode" 
            value="{% if form.instance.strategy %}True{% else %}False{% endif %}">
</div>
{% endblock %}

{% block currency %}
    <div class="currency-section">
        <h3>Торговая пара</h3>
        <div class="currency-inputs">
            <div class="currency-radio">
                {% for value, label in form.base_currency.field.choices %}
                    <label>
                        <input type="radio" name="{{ form.base_currency.name }}" value="{{ value }}"
                               {% if form.base_currency.value == value or form.base_currency.initial == value %}checked{% endif %}>
                        {{ label }}
                    </label>
                {% endfor %}
            </div>
            <span>/USDT</span>
        </div>
        {% if form.base_currency.value == 'CUSTOM' or form.base_currency.initial == 'CUSTOM' %}
            <div class="custom-currency">
                <label for="{{ form.custom_currency.id_for_label }}">Пользовательская валюта</label>
                {{ form.custom_currency }}
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block indicators_section %}
    <div class="indicators-section">
        <h3>Индикаторы для входа</h3>
        <div class="indicators-list">
            {{ formset.management_form }}
            {% for form in formset %}
                {% if form.instance.pk or not formset.can_delete %}
                    <div class="indicator-item">
                        {{ form.id }}
                        <div class="indicator-row">
                            <div class="form-group">
                                <label>Индикатор</label>
                                {{ form.indicator_type }}
                            </div>
                            <div class="form-group">
                                <label>Таймфрейм</label>
                                {{ form.timeframe }}
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="form-group">
                                <label>Условие</label>
                                {{ form.condition }}
                            </div>
                            <div class="form-group">
                                <label>Значение</label>
                                {{ form.value }}
                            </div>
                        </div>
                        {% if formset.can_delete %}
                            <div class="delete-indicator">
                                <label><input type="checkbox" name="{{ form.DELETE.name }}" id="{{ form.DELETE.id_for_label }}"> Удалить индикатор</label>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <button type="button" class="add-indicator">Добавить индикатор</button>
    </div>
{% endblock %}


{% block risk_management %}
    <div class="risk-management-section">
        <h3>Управление рисками</h3>
        <div class="risk-management-inputs">
            <div class="form-group">
                <label for="{{ form.take_profit_percent.id_for_label }}">Take Profit (%)</label>
                {{ form.take_profit_percent }}
                {% if form.take_profit_percent.errors %}
                    <div class="error">{{ form.take_profit_percent.errors }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="add-stop-loss" {% if form.stop_loss_percent.value %}checked{% endif %}>
                    Добавить Stop Loss
                </label>
                <div id="stop-loss-container" {% if not form.stop_loss_percent.value %}style="display: none;"{% endif %}>
                    <label for="{{ form.stop_loss_percent.id_for_label }}">Stop Loss (%)</label>
                    {{ form.stop_loss_percent }}
                    {% if form.stop_loss_percent.errors %}
                        <div class="error">{{ form.stop_loss_percent.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}



{% block form_actions %}
<div class="form-actions">
    <div>
        <button type="submit" class="btn btn-primary" name="save_settings">
            <i class="fas fa-save"></i> Сохранить настройки
        </button>
    </div>
</div>

<!-- Модальное окно подтверждения -->
{% if show_confirmation %}
<div class="modal-overlay" id="confirmationModal">
    <div class="modal-content">
        <h3>Подтверждение изменений</h3>
        <p>Новые настройки будут применены после выхода бота из текущих сделок.</p>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="document.getElementById('confirmationModal').style.display='none'">
                Отмена
            </button>
            <button type="submit" class="btn btn-primary" name="confirm_save">
                Подтвердить
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация ползунка плеча
    const leverageSlider = document.getElementById('leverageSlider');
    const leverageValue = document.getElementById('leverageValue');
    
    // Устанавливаем начальное значение из формы
    leverageSlider.value = {{ form.bot_leverage.value|default:10 }};
    leverageValue.textContent = leverageSlider.value + 'x';
    
    leverageSlider.addEventListener('input', function() {
        leverageValue.textContent = this.value + 'x';
    });
});
</script>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация ползунка плеча
    const leverageSlider = document.getElementById('leverageSlider');
    const leverageValue = document.getElementById('leverageValue');
    leverageSlider.value = {{ form.instance.bot_leverage|default:10 }};
    leverageValue.textContent = leverageSlider.value + 'x';
    
    leverageSlider.addEventListener('input', function() {
        leverageValue.textContent = this.value + 'x';
    });

    // Обработка выбора валюты
    document.getElementById('baseCurrencySelect').addEventListener('change', function() {
        const customInput = document.getElementById('customCurrencyInput');
        customInput.style.display = (this.value === 'CUSTOM') ? 'block' : 'none';
    });

    // Обработка Stop Loss
    document.getElementById('stopLossToggle').addEventListener('change', function() {
        const stopLossContainer = document.getElementById('stopLossContainer');
        stopLossContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('stopLossValue').value = '';
        }
    });
});
</script>
{% endblock %}

<!-- Добавим стили для модального окна -->
<style>
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 500px;
}
.modal-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 20px;
    gap: 10px;
}
</style>