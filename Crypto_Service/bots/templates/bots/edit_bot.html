{% extends 'bots/bot_conf.html' %}


{% block strategy %}
<div class="form-group">
    <label class="form-label">Алгоритм торговли</label>
    <div class="mode-selector">
        <div class="mode-option {% if form.instance.strategy %}active{% endif %}" onclick="selectMode(this, 'long')">
            <h4>Long</h4>
            <p>Покупка с ожиданием роста</p>
        </div>
        <div class="mode-option {% if not form.instance.strategy %}active{% endif %}" onclick="selectMode(this, 'short')">
            <h4>Short</h4>
            <p>Продажа с ожиданием падения</p>
        </div>
    </div>
    <input type="hidden" name="strategy" id="tradingMode" 
            value="{% if form.instance.strategy %}True{% else %}False{% endif %}">
</div>
{% endblock %}

{% block currency %}
<div class="form-group">
    <label class="form-label">Торговая пара</label>
    <div class="pair-selector">
        <div class="dropdown" style="flex: 1;">
            <select name="base_currency" class="form-control" id="baseCurrencySelect">
                {% for value, label in form.base_currency.field.choices %}
                    <option value="{{ value }}" {% if value == form.base_currency.value %}selected{% endif %}>
                        {{ label }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <span class="pair-divider">/USDT</span>
    </div>
    <div id="customCurrencyInput" style="display: {% if form.base_currency.value == 'CUSTOM' %}block{% else %}none{% endif %}; margin-top: 10px;">
        <input type="text" class="form-control" name="custom_currency" 
                value="{{ form.custom_currency.value|default:'' }}" 
                placeholder="Введите код валюты (например: ADA)">
    </div>
</div>
{% endblock %}

{% block indicators_section %}
<div class="form-section">
    <h2 class="section-title"><i class="fas fa-chart-line"></i> Индикаторы для входа</h2>
    <!-- Индикаторы -->
    <div style="display:none;">
        {{ formset.management_form }}
    </div>
    <div id="indicatorsContainer">
        {% for form in formset %}
            {% if not form.DELETE.value %}  <!-- Исключаем удалённые индикаторы -->
                <div class="indicator-form">
                    {{ form.id }}
                    <div class="indicator-row">
                        <div class="form-group">
                            <label class="form-label">Индикатор</label>
                            {{ form.indicator_type }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Таймфрейм</label>
                            {{ form.timeframe }}
                        </div>
                    </div>
                    <div class="indicator-row">
                        <div class="form-group">
                            <label class="form-label">Условие</label>
                            {{ form.condition }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Значение</label>
                            {{ form.value }}
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline" onclick="this.parentNode.remove()">
                        <i class="fas fa-trash"></i> Удалить индикатор
                    </button>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    
    <button type="button" class="btn btn-outline add-indicator-btn" onclick="addIndicator()">
        <i class="fas fa-plus"></i> Добавить индикатор
    </button>
</div>
{% endblock %}


{% block risk_management %}
<div class="form-section">
    <h2 class="section-title"><i class="fas fa-shield-alt"></i> Управление рисками</h2>
    
    <div class="grid-settings">
        <div class="grid-setting">
            <div class="form-group">
                <label class="form-label">Take Profit (%)</label>
                <input type="number" class="form-control" name="take_profit_percent" 
                       value="{{ form.instance.take_profit_percent|floatformat:1 }}" 
                       min="0.1" max="100" step="0.1" required>
            </div>
        </div>
        
        <div class="grid-setting">
            <div class="form-group">
                <label class="form-label">
                    Добавить Stop Loss
                    <label class="toggle-switch">
                        <input type="checkbox" id="stopLossToggle" {% if form.instance.stop_loss_percent %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </label>
                <div class="stop-loss-container" id="stopLossContainer" 
                     style="display: {% if form.instance.stop_loss_percent %}block{% else %}none{% endif %};">
                    <input type="number" class="form-control" name="stop_loss_percent" id="stopLossValue" 
                           value="{{ form.instance.stop_loss_percent|floatformat:1|default:'' }}" 
                           placeholder="2" min="0.1" max="100" step="0.1">
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block form_actions %}
<div class="form-actions">
    <div>
        <button type="submit" class="btn btn-primary" name="save_settings">
            <i class="fas fa-save"></i> Сохранить настройки
        </button>
    </div>
</div>

<!-- Модальное окно подтверждения -->
{% if show_confirmation %}
<div class="modal-overlay" id="confirmationModal">
    <div class="modal-content">
        <h3>Подтверждение изменений</h3>
        <p>Новые настройки будут применены после выхода бота из текущих сделок.</p>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="document.getElementById('confirmationModal').style.display='none'">
                Отмена
            </button>
            <button type="submit" class="btn btn-primary" name="confirm_save">
                Подтвердить
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация ползунка плеча
    const leverageSlider = document.getElementById('leverageSlider');
    const leverageValue = document.getElementById('leverageValue');
    
    // Устанавливаем начальное значение из формы
    leverageSlider.value = {{ form.bot_leverage.value|default:10 }};
    leverageValue.textContent = leverageSlider.value + 'x';
    
    leverageSlider.addEventListener('input', function() {
        leverageValue.textContent = this.value + 'x';
    });
});
</script>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация ползунка плеча
    const leverageSlider = document.getElementById('leverageSlider');
    const leverageValue = document.getElementById('leverageValue');
    leverageSlider.value = {{ form.instance.bot_leverage|default:10 }};
    leverageValue.textContent = leverageSlider.value + 'x';
    
    leverageSlider.addEventListener('input', function() {
        leverageValue.textContent = this.value + 'x';
    });

    // Обработка выбора валюты
    document.getElementById('baseCurrencySelect').addEventListener('change', function() {
        const customInput = document.getElementById('customCurrencyInput');
        customInput.style.display = (this.value === 'CUSTOM') ? 'block' : 'none';
    });

    // Обработка Stop Loss
    document.getElementById('stopLossToggle').addEventListener('change', function() {
        const stopLossContainer = document.getElementById('stopLossContainer');
        stopLossContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            document.getElementById('stopLossValue').value = '';
        }
    });
});
</script>
{% endblock %}

<!-- Добавим стили для модального окна -->
<style>
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 500px;
}
.modal-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 20px;
    gap: 10px;
}
</style>